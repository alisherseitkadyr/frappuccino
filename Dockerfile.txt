FROM golang:1.22

WORKDIR /app

# Copy the go.mod and go.sum files for dependencies
COPY go.mod ./
COPY go.sum ./

RUN go mod download

# Copy the application code
COPY . .

# Copy the wait-for-it.sh script into the container
COPY wait-for-it.sh /wait-for-it.sh
RUN chmod +x /wait-for-it.sh

# Build the Go app
RUN go build -o main ./cmd/main.go

EXPOSE 8080

# Entry point: wait for the database and then start the Go app
CMD ["/wait-for-it.sh", "db:5432", "--timeout=30", "--", "./main"]
